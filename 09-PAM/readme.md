# PAM

## Запретить всем пользователям, кроме группы admin логин в выходные и праздничные дни

Cоздадим 3х пользователей:

```
useradd day
useradd friday
```

Назначим им пароли:

```
echo "Otus2019" | sudo passwd --stdin day
echo "Otus2019" | sudo passwd --stdin friday
```

Создадим группу admin и добавим туда пользователя day.

```
groupadd admin
usermod -aG admin day
```

# PAM. Модуль pam_time
Модуль **pam_time** позволяет достаточно гибко настроить доступ пользователя с учетом времени. Настройки данного модуля хранятся в файле ``/etc/security/time.conf``. Данный файл содержит в себе пояснения и примеры использования. Добавим в конец файла строки:

```
login ; * ; !admin ; Wd
sshd ; * ; !admin ; Wd
```

Разные параметры отделяются символом ";". Разберем первую строку:
- “*” сервис, к которому применяется правило
- "*" имя терминала, к которому применяется правило
- имя пользователя, для которого данное правило будет действовать
- время, когда правило носит разрешающий характер

Теперь настроим PAM, так как по-умолчанию данный модуль не подключен.
Для этого приведем файл ``/etc/pam.d/sshd`` к виду:

```
...
account required pam_nologin.so
account required pam_time.so
...
```

## Дать конкретному пользователю права рута

Попробуем выполнить команду nc от пользователя ``day`` и получим сообщение об ошибке.

```
sudo -u day ncat -l -p 80
Ncat: bind to :::80: Permission denied. QUITTING.
```

Это связано с тем, что непривелигерованный пользователь day, от имени которого выполняется команда, не может открыть для прослушивания 80й порт.

Эту задачу можно решить несколькими способами:
- установить suid-бит. Установка данного бита позволит выполнить ncat так, будто он запущен от root. Способ имеет низкую гибкость, так как установка бита позволит любому пользователю выполнить команду;
- предоставить пользователю права (возможности), чтобы он смог открыть порт. Способ более гибкий, потому что можно указать что именно, кому и при помощи какой программы мы разрешаем;

Решим задачу вторым способом. Для этого воспользумся pamмодулем pam_cap. Поскольку это демо стенд, то SELinux можно просто выключить выполнив

```
setenforce 0
```

Отключать SELinux в продакшене крайне не рекомендуется.

Приведем файл ``/etc/pam.d/sshd`` к виду:

```
...
auth include postlogin
auth required pam_cap.so
...
```

Таким образом мы включили обработку capabilities при подключении по ssh. Пропишем необходимые права пользователю day. Для этого создадим файл ``/etc/security/capability.conf`` содержащий одну строку:

```
cap_net_bind_service day
```

Теперь необходимо программе (``/usr/bin/ncat``), при помощи которой будет открываться порт, так же выдать разрешение на данное действие:

```
setcap cap_net_bind_service=ei /usr/bin/ncat
```

Мы сопоставили права, выданные пользователю с правами выданными на программу. Снова зайдем на стенд под пользователем day и проверим, что мы получили необходимые права:

```
su day
capsh --print
Current: = cap_net_bind_service+i
```

Теперь попробуем выполнить команду:

```
ncat -l -p 80
```

Теперь ошибки не возникло. Теперь можно открыть еще одну консоль и там выполнить:

```
echo "Make Linux great again!" > \
/dev/tcp/127.0.0.7/80
```

и увидеть сообщение в перовой консоли.
